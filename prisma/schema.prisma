// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. PRODUCTS (The Foundation)
// ============================================
model Product {
  sku            String   @id // Master SKU - primary key
  title          String
  displayName    String?  @map("display_name") // Custom name for display (e.g., rename ugly parent SKUs)
  description    String?  @db.Text
  brand          String   @default("KISPER")
  category       String?
  isHidden       Boolean  @default(false) @map("is_hidden") // Hide from all reports/views
  
  // Parent/Child Relationship (for variations)
  parentSku      String?  @map("parent_sku")
  parent         Product? @relation("ProductVariations", fields: [parentSku], references: [sku])
  variations     Product[] @relation("ProductVariations")
  isParent       Boolean  @default(false) @map("is_parent")
  variationType  String?  @map("variation_type") // e.g., "Size", "Color"
  variationValue String?  @map("variation_value") // e.g., "Large", "Blue"
  
  // Amazon Identifiers
  asin           String?
  fnsku          String?
  upc            String?
  
  // Financials
  cost           Decimal  @db.Decimal(10, 2)
  price          Decimal  @db.Decimal(10, 2)
  mapPrice       Decimal? @db.Decimal(10, 2) @map("map_price")
  msrp           Decimal? @db.Decimal(10, 2)
  
  // Supplier Link
  supplierId     Int?     @map("supplier_id")
  supplier       Supplier? @relation(fields: [supplierId], references: [id])
  supplierSku    String?  @map("supplier_sku")
  
  // Physical (needed for FBA fees)
  weightOz       Decimal? @db.Decimal(8, 2) @map("weight_oz")
  lengthIn       Decimal? @db.Decimal(8, 2) @map("length_in")
  widthIn        Decimal? @db.Decimal(8, 2) @map("width_in")
  heightIn       Decimal? @db.Decimal(8, 2) @map("height_in")
  
  // Prep Requirements
  prepType       String?  @default("none") @map("prep_type") // none, poly_bag, bubble_wrap, sticker
  labelingRequired Boolean @default(false) @map("labeling_required")
  unitsPerCase   Int?     @map("units_per_case")
  
  // Status
  status         String   @default("active") // active, discontinued, seasonal, liquidate
  launchDate     DateTime? @map("launch_date")
  
  // Notes
  notes          String?  @db.Text
  
  // Relations
  skuMappings    SkuMapping[]
  inventoryLevels InventoryLevel[]
  orderItems     OrderItem[]
  purchaseOrderItems PurchaseOrderItem[]
  fbaShipmentItems FbaShipmentItem[]
  salesVelocity  SalesVelocity?
  demandForecasts DemandForecast[]
  dailyProfits   DailyProfit[]
  returns        Return[]
  feeEstimates   FeeEstimate?
  bundleComponents BundleComponent[] @relation("ComponentProduct")
  bundleProducts Bundle[] @relation("BundleProduct")
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  @@map("products")
}

// ============================================
// 1.5 SKU MAPPING (Channel Variants)
// ============================================
model SkuMapping {
  id                Int      @id @default(autoincrement())
  masterSku         String   @map("master_sku")
  product           Product  @relation(fields: [masterSku], references: [sku], onDelete: Cascade)
  
  channel           String   // amazon_us, amazon_uk, amazon_ca, walmart, shopify, ebay, supplier
  channelSku        String   @map("channel_sku")
  channelProductId  String?  @map("channel_product_id") // ASIN, Walmart ID, etc.
  channelFnsku      String?  @map("channel_fnsku")
  
  // Channel-specific pricing
  channelPrice      Decimal? @db.Decimal(10, 2) @map("channel_price")
  channelCurrency   String?  @default("USD") @map("channel_currency")
  
  // Channel-specific inventory
  tracksInventory   Boolean  @default(true) @map("tracks_inventory")
  
  // Status
  isActive          Boolean  @default(true) @map("is_active")
  
  // Relations
  channelInventory  ChannelInventory[]
  salesHistory      SalesHistory[]
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  @@unique([masterSku, channel])
  @@map("sku_mappings")
}

// ============================================
// 2. SUPPLIERS
// ============================================
model Supplier {
  id                  Int      @id @default(autoincrement())
  name                String
  contactName         String?  @map("contact_name")
  email               String?
  phone               String?
  website             String?
  address             String?  @db.Text
  country             String?
  
  // Terms
  leadTimeDays        Int?     @map("lead_time_days")
  paymentTerms        String?  @map("payment_terms")
  minimumOrderValue   Decimal? @db.Decimal(10, 2) @map("minimum_order_value")
  minimumOrderQuantity Int?    @map("minimum_order_quantity")
  
  // Banking
  paymentMethod       String?  @map("payment_method")
  paymentDetails      String?  @db.Text @map("payment_details") // Encrypted
  
  // Performance Tracking
  avgActualLeadTime   Decimal? @db.Decimal(5, 2) @map("avg_actual_lead_time")
  qualityRating       Decimal? @db.Decimal(3, 2) @map("quality_rating")
  onTimeRate          Decimal? @db.Decimal(5, 2) @map("on_time_rate")
  
  // Status
  status              String   @default("active")
  notes               String?  @db.Text
  
  // Relations
  products            Product[]
  purchaseOrders      PurchaseOrder[]
  backorders          Backorder[]
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("suppliers")
}

// ============================================
// 3. INVENTORY LEVELS
// ============================================
model InventoryLevel {
  id                    Int      @id @default(autoincrement())
  masterSku             String   @map("master_sku")
  product               Product  @relation(fields: [masterSku], references: [sku], onDelete: Cascade)
  
  // Amazon FBA
  fbaAvailable          Int      @default(0) @map("fba_available")
  fbaInboundWorking     Int      @default(0) @map("fba_inbound_working")
  fbaInboundShipped     Int      @default(0) @map("fba_inbound_shipped")
  fbaInboundReceiving   Int      @default(0) @map("fba_inbound_receiving")
  fbaReserved           Int      @default(0) @map("fba_reserved")
  fbaUnfulfillable      Int      @default(0) @map("fba_unfulfillable")
  
  // Warehouse
  warehouseAvailable    Int      @default(0) @map("warehouse_available")
  warehouseReserved    Int      @default(0) @map("warehouse_reserved")
  
  // Amazon Limits
  restockLimit          Int?     @map("restock_limit")
  currentUtilization    Decimal? @db.Decimal(5, 2) @map("current_utilization")
  
  // Sync
  fbaLastSync           DateTime? @map("fba_last_sync")
  warehouseLastSync     DateTime? @map("warehouse_last_sync")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  @@unique([masterSku])
  @@map("inventory_levels")
}

// ============================================
// 3.5 CHANNEL INVENTORY (Per-Channel Tracking)
// ============================================
model ChannelInventory {
  id                    Int      @id @default(autoincrement())
  masterSku             String   @map("master_sku")
  channel               String   // amazon_us, amazon_uk, etc.
  channelSku            String   @map("channel_sku")
  skuMapping            SkuMapping @relation(fields: [masterSku, channel], references: [masterSku, channel])
  
  // Inventory at this channel's FBA
  fbaAvailable          Int      @default(0) @map("fba_available")
  fbaInboundWorking     Int      @default(0) @map("fba_inbound_working")
  fbaInboundShipped     Int      @default(0) @map("fba_inbound_shipped")
  fbaInboundReceiving   Int      @default(0) @map("fba_inbound_receiving")
  fbaReserved           Int      @default(0) @map("fba_reserved")
  fbaUnfulfillable      Int      @default(0) @map("fba_unfulfillable")
  
  // This channel's limits
  restockLimit          Int?     @map("restock_limit")
  restockLimitUsed      Int?     @default(0) @map("restock_limit_used")
  
  // This channel's velocity
  velocity7d            Decimal? @db.Decimal(10, 2) @map("velocity_7d")
  velocity30d           Decimal? @db.Decimal(10, 2) @map("velocity_30d")
  velocity90d           Decimal? @db.Decimal(10, 2) @map("velocity_90d")
  
  // This channel's forecast
  daysOfStock           Decimal? @db.Decimal(10, 2) @map("days_of_stock")
  stockoutDate          DateTime? @map("stockout_date")
  
  // Seasonality specific to this channel
  seasonalityFactor     Decimal? @db.Decimal(5, 2) @default(1.0) @map("seasonality_factor")
  
  lastSynced            DateTime? @map("last_synced")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  @@unique([masterSku, channel])
  @@map("channel_inventory")
}

// ============================================
// 4. ORDERS & SALES
// ============================================
model Order {
  id                  String   @id // Amazon order ID
  purchaseDate        DateTime @map("purchase_date")
  shipDate            DateTime? @map("ship_date")
  
  // Customer (limited data Amazon gives)
  shipCity            String?  @map("ship_city")
  shipState           String?  @map("ship_state")
  shipCountry         String?  @map("ship_country")
  
  // Status
  status              String   // pending, shipped, delivered, cancelled, returned
  fulfillmentChannel String?  @map("fulfillment_channel") // FBA or FBM
  
  // Relations
  orderItems          OrderItem[]
  returns             Return[]
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("orders")
}

model OrderItem {
  id              Int      @id @default(autoincrement())
  orderId         String   @map("order_id")
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  masterSku       String   @map("master_sku")
  product         Product  @relation(fields: [masterSku], references: [sku])
  
  quantity        Int
  itemPrice       Decimal  @db.Decimal(10, 2) @map("item_price")
  itemTax         Decimal? @db.Decimal(10, 2) @default(0) @map("item_tax")
  shippingPrice   Decimal? @db.Decimal(10, 2) @default(0) @map("shipping_price")
  shippingTax     Decimal? @db.Decimal(10, 2) @default(0) @map("shipping_tax")
  
  // For profit calculation
  amazonFees      Decimal? @db.Decimal(10, 2) @default(0) @map("amazon_fees")
  
  // Promo
  promoDiscount   Decimal? @db.Decimal(10, 2) @default(0) @map("promo_discount")
  promoIds        String?  @map("promo_ids")
  
  // Relations
  amazonFeesDetail AmazonFee?
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("order_items")
}

// ============================================
// 5. AMAZON FEES
// ============================================
model AmazonFee {
  id                    Int      @id @default(autoincrement())
  orderItemId           Int      @unique @map("order_item_id")
  orderItem             OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  
  // Fee Breakdown
  referralFee           Decimal  @db.Decimal(10, 2) @default(0) @map("referral_fee")
  fbaFulfillmentFee     Decimal  @db.Decimal(10, 2) @default(0) @map("fba_fulfillment_fee")
  fbaWeightHandling     Decimal? @db.Decimal(10, 2) @default(0) @map("fba_weight_handling")
  variableClosingFee    Decimal? @db.Decimal(10, 2) @default(0) @map("variable_closing_fee")
  
  // Storage (monthly, allocated per unit)
  monthlyStorageFee     Decimal? @db.Decimal(10, 2) @default(0) @map("monthly_storage_fee")
  longTermStorageFee    Decimal? @db.Decimal(10, 2) @default(0) @map("long_term_storage_fee")
  
  // Other
  removalFee            Decimal? @db.Decimal(10, 2) @default(0) @map("removal_fee")
  disposalFee           Decimal? @db.Decimal(10, 2) @default(0) @map("disposal_fee")
  returnProcessingFee   Decimal? @db.Decimal(10, 2) @default(0) @map("return_processing_fee")
  
  // Total
  totalFees             Decimal  @db.Decimal(10, 2) @map("total_fees")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  @@map("amazon_fees")
}

model FeeEstimate {
  id                    Int      @id @default(autoincrement())
  masterSku             String   @unique @map("master_sku")
  product               Product  @relation(fields: [masterSku], references: [sku], onDelete: Cascade)
  
  estimatedReferralFee  Decimal? @db.Decimal(10, 2) @map("estimated_referral_fee")
  estimatedFbaFee       Decimal? @db.Decimal(10, 2) @map("estimated_fba_fee")
  estimatedStorageFeeMonthly Decimal? @db.Decimal(10, 2) @map("estimated_storage_fee_monthly")
  
  lastUpdated           DateTime @default(now()) @map("last_updated")
  
  @@map("fee_estimates")
}

// ============================================
// 6. RETURNS
// ============================================
model Return {
  id                  Int      @id @default(autoincrement())
  returnId            String   @unique @map("return_id")
  orderId             String   @map("order_id")
  order               Order    @relation(fields: [orderId], references: [id])
  
  masterSku           String   @map("master_sku")
  product             Product  @relation(fields: [masterSku], references: [sku])
  
  // Timing
  returnDate          DateTime @map("return_date")
  
  // Details
  quantity            Int
  reason              String?
  customerComments    String?  @db.Text @map("customer_comments")
  
  // What happened to the item
  disposition         String   // sellable, damaged, customer_damaged, defective
  
  // Financial
  refundAmount        Decimal  @db.Decimal(10, 2) @map("refund_amount")
  returnShippingFee   Decimal? @db.Decimal(10, 2) @default(0) @map("return_shipping_fee")
  restockingFee       Decimal? @db.Decimal(10, 2) @default(0) @map("restocking_fee")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("returns")
}

// ============================================
// 7. PURCHASE ORDERS
// ============================================
model PurchaseOrder {
  id                  Int      @id @default(autoincrement())
  poNumber            String   @unique @map("po_number")
  supplierId          Int      @map("supplier_id")
  supplier            Supplier @relation(fields: [supplierId], references: [id])
  
  // Status
  status              String   // draft, sent, confirmed, shipped, partial, received, cancelled
  
  // Dates
  createdDate         DateTime @default(now()) @map("created_date")
  sentDate            DateTime? @map("sent_date")
  confirmedDate       DateTime? @map("confirmed_date")
  expectedShipDate    DateTime? @map("expected_ship_date")
  expectedArrivalDate DateTime? @map("expected_arrival_date")
  actualShipDate      DateTime? @map("actual_ship_date")
  actualArrivalDate   DateTime? @map("actual_arrival_date")
  
  // Shipping
  carrier             String?
  trackingNumber      String?  @map("tracking_number")
  
  // Financials
  subtotal            Decimal  @db.Decimal(10, 2) @default(0)
  shippingCost        Decimal? @db.Decimal(10, 2) @default(0) @map("shipping_cost")
  tax                 Decimal? @db.Decimal(10, 2) @default(0)
  total               Decimal  @db.Decimal(10, 2) @default(0)
  
  // Payment
  paymentStatus       String   @default("unpaid") @map("payment_status") // unpaid, partial, paid
  paymentDate         DateTime? @map("payment_date")
  paymentMethod       String?  @map("payment_method")
  paymentReference    String?  @map("payment_reference")
  
  notes               String?  @db.Text
  
  // Relations
  items               PurchaseOrderItem[]
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id                  Int      @id @default(autoincrement())
  poId                Int      @map("po_id")
  purchaseOrder        PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  
  masterSku           String   @map("master_sku")
  product             Product  @relation(fields: [masterSku], references: [sku])
  
  quantityOrdered     Int      @map("quantity_ordered")
  unitCost            Decimal  @db.Decimal(10, 2) @map("unit_cost")
  lineTotal           Decimal  @db.Decimal(10, 2) @map("line_total")
  
  quantityReceived    Int      @default(0) @map("quantity_received")
  quantityDamaged     Int      @default(0) @map("quantity_damaged")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("purchase_order_items")
}

// ============================================
// 7.5 BACKORDERS
// ============================================
model Backorder {
  id                  Int      @id @default(autoincrement())
  
  // Reference to original PO
  poId                Int      @map("po_id")
  poNumber            String   @map("po_number")
  supplierId          Int      @map("supplier_id")
  supplier            Supplier @relation(fields: [supplierId], references: [id])
  
  // Item details
  masterSku           String   @map("master_sku")
  quantity            Int
  unitCost            Decimal  @db.Decimal(10, 2) @map("unit_cost")
  
  // Status
  status              String   @default("pending") // pending, received, cancelled
  
  // Dates
  createdDate         DateTime @default(now()) @map("created_date")
  expectedDate        DateTime? @map("expected_date")
  receivedDate        DateTime? @map("received_date")
  
  // Quantities
  quantityReceived    Int      @default(0) @map("quantity_received")
  quantityDamaged     Int      @default(0) @map("quantity_damaged")
  
  notes               String?  @db.Text
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("backorders")
}

// ============================================
// 8. FBA SHIPMENTS
// ============================================
model FbaShipment {
  id                  Int      @id @default(autoincrement())
  shipmentId          String   @unique @map("shipment_id") // Amazon's shipment ID
  internalId          String?  @map("internal_id")
  
  // Status
  status              String   // draft, working, shipped, in_transit, delivered, checked_in, receiving, closed, cancelled
  
  // Destination
  destinationFc       String?  @map("destination_fc")
  destinationName     String?  @map("destination_name")
  channel             String?  // amazon_us, amazon_uk, amazon_ca
  
  // Dates
  createdDate         DateTime @default(now()) @map("created_date")
  shipDate            DateTime? @map("ship_date")
  estimatedArrival    DateTime? @map("estimated_arrival")
  checkedInDate       DateTime? @map("checked_in_date")
  closedDate          DateTime? @map("closed_date")
  
  // Shipping
  carrier             String?
  trackingNumbers     String?  @db.Text @map("tracking_numbers") // JSON array
  
  // Boxes
  numBoxes            Int?     @default(0) @map("num_boxes")
  totalUnits          Int      @default(0) @map("total_units")
  totalWeight         Decimal? @db.Decimal(10, 2) @map("total_weight")
  
  // Reconciliation
  unitsShipped        Int      @default(0) @map("units_shipped")
  unitsReceived       Int      @default(0) @map("units_received")
  unitsDiscrepancy    Int      @default(0) @map("units_discrepancy")
  reimbursementStatus String?  @map("reimbursement_status")
  
  // Relations
  items               FbaShipmentItem[]
  boxes               FbaShipmentBox[]
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("fba_shipments")
}

model FbaShipmentItem {
  id                  Int      @id @default(autoincrement())
  shipmentId          Int      @map("shipment_id")
  shipment            FbaShipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  masterSku           String   @map("master_sku")
  channelSku          String?  @map("channel_sku")
  product             Product  @relation(fields: [masterSku], references: [sku])
  
  quantityShipped     Int      @map("quantity_shipped")
  quantityReceived    Int      @default(0) @map("quantity_received")
  quantityDiscrepancy Int      @default(0) @map("quantity_discrepancy")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("fba_shipment_items")
}

model FbaShipmentBox {
  id                  Int      @id @default(autoincrement())
  shipmentId          Int      @map("shipment_id")
  shipment            FbaShipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  boxNumber           Int      @map("box_number")
  weightLbs           Decimal? @db.Decimal(8, 2) @map("weight_lbs")
  dimensions          String?  // LxWxH
  items               String?  @db.Text // JSONB of what's in this box
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("fba_shipment_boxes")
}

// ============================================
// 9. PROFIT TRACKING
// ============================================
model DailyProfit {
  id                  Int      @id @default(autoincrement())
  date                DateTime @db.Date
  masterSku           String   @map("master_sku")
  product             Product  @relation(fields: [masterSku], references: [sku], onDelete: Cascade)
  
  // Sales
  unitsSold           Int      @default(0) @map("units_sold")
  revenue             Decimal  @db.Decimal(10, 2) @default(0)
  
  // Costs
  amazonFees          Decimal  @db.Decimal(10, 2) @default(0) @map("amazon_fees")
  cogs                Decimal  @db.Decimal(10, 2) @default(0) // units_sold * product.cost
  ppcSpend            Decimal  @db.Decimal(10, 2) @default(0) @map("ppc_spend")
  refunds             Decimal  @db.Decimal(10, 2) @default(0)
  promoDiscounts      Decimal  @db.Decimal(10, 2) @default(0) @map("promo_discounts")
  
  // Result
  grossProfit         Decimal  @db.Decimal(10, 2) @default(0) @map("gross_profit")
  netProfit           Decimal  @db.Decimal(10, 2) @default(0) @map("net_profit")
  profitMargin        Decimal  @db.Decimal(5, 2) @default(0) @map("profit_margin")
  roi                 Decimal  @db.Decimal(5, 2) @default(0)
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@unique([date, masterSku])
  @@map("daily_profit")
}

model DailySummary {
  id                  Int      @id @default(autoincrement())
  date                DateTime @unique @db.Date
  
  totalRevenue        Decimal  @db.Decimal(12, 2) @default(0) @map("total_revenue")
  totalFees           Decimal  @db.Decimal(12, 2) @default(0) @map("total_fees")
  totalCogs           Decimal  @db.Decimal(12, 2) @default(0) @map("total_cogs")
  totalPpc            Decimal  @db.Decimal(12, 2) @default(0) @map("total_ppc")
  totalRefunds        Decimal  @db.Decimal(12, 2) @default(0) @map("total_refunds")
  totalProfit         Decimal  @db.Decimal(12, 2) @default(0) @map("total_profit")
  
  unitsSold           Int      @default(0) @map("units_sold")
  ordersCount         Int      @default(0) @map("orders_count")
  
  // Comparison
  profitVsYesterday   Decimal? @db.Decimal(12, 2) @map("profit_vs_yesterday")
  profitVsLastWeek    Decimal? @db.Decimal(12, 2) @map("profit_vs_last_week")
  profitVsLastMonth   Decimal? @db.Decimal(12, 2) @map("profit_vs_last_month")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("daily_summary")
}

// ============================================
// 10. FORECASTING & VELOCITY
// ============================================
model SalesVelocity {
  id                    Int      @id @default(autoincrement())
  masterSku             String   @unique @map("master_sku")
  product               Product  @relation(fields: [masterSku], references: [sku], onDelete: Cascade)
  
  // Velocity at different timeframes
  velocity7d            Decimal  @db.Decimal(10, 2) @default(0) @map("velocity_7d")
  velocity30d           Decimal  @db.Decimal(10, 2) @default(0) @map("velocity_30d")
  velocity90d            Decimal  @db.Decimal(10, 2) @default(0) @map("velocity_90d")
  
  // Trend
  trend                 String?  // rising, stable, declining
  trendPercent          Decimal? @db.Decimal(5, 2) @map("trend_percent")
  
  // Stockout Impact
  daysOutOfStock30d     Int      @default(0) @map("days_out_of_stock_30d")
  estimatedLostSales    Int      @default(0) @map("estimated_lost_sales")
  
  lastCalculated        DateTime @default(now()) @map("last_calculated")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  @@map("sales_velocity")
}

model DemandForecast {
  id                  Int      @id @default(autoincrement())
  masterSku           String   @map("master_sku")
  product             Product  @relation(fields: [masterSku], references: [sku], onDelete: Cascade)
  
  channel             String?  // amazon_us, amazon_uk, etc.
  channelSku          String?  @map("channel_sku")
  
  forecastDate        DateTime @map("forecast_date")
  
  // Predictions
  predictedUnits      Decimal  @db.Decimal(10, 2) @map("predicted_units")
  confidence          Decimal  @db.Decimal(5, 2) // 0-1
  
  // Factors applied
  seasonalityFactor   Decimal? @db.Decimal(5, 2) @default(1.0) @map("seasonality_factor")
  trendFactor         Decimal? @db.Decimal(5, 2) @default(1.0) @map("trend_factor")
  promoFactor         Decimal? @db.Decimal(5, 2) @default(1.0) @map("promo_factor")
  
  // Result
  recommendedStock    Int      @map("recommended_stock")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("demand_forecast")
}

model SalesHistory {
  id                  Int      @id @default(autoincrement())
  masterSku           String   @map("master_sku")
  channel             String   // amazon_us, amazon_uk, etc.
  channelSku          String   @map("channel_sku")
  skuMapping          SkuMapping @relation(fields: [masterSku, channel], references: [masterSku, channel])
  
  date                DateTime @db.Date
  
  unitsSold           Int      @default(0) @map("units_sold")
  revenue              Decimal  @db.Decimal(10, 2) @default(0)
  revenueUsd           Decimal  @db.Decimal(10, 2) @default(0) @map("revenue_usd")
  
  fees                 Decimal  @db.Decimal(10, 2) @default(0)
  feesUsd              Decimal  @db.Decimal(10, 2) @default(0) @map("fees_usd")
  
  currency             String   @default("USD")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@unique([masterSku, channel, date])
  @@map("sales_history")
}

// ============================================
// 11. ALERTS & NOTIFICATIONS
// ============================================
model AlertConfig {
  id                  Int      @id @default(autoincrement())
  alertType           String   @map("alert_type") // low_stock, stockout, hijacker, etc.
  
  enabled              Boolean  @default(true)
  threshold            String?  @db.Text // JSONB with alert-specific settings
  
  notifyVia            String?  @map("notify_via") // in_app, email, sms
  frequency            String?  @default("instant") // instant, daily_digest
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@unique([alertType])
  @@map("alert_configs")
}

model Alert {
  id                  Int      @id @default(autoincrement())
  alertType           String   @map("alert_type")
  severity            String   // info, warning, critical
  
  masterSku           String?  @map("master_sku")
  
  title               String
  message             String   @db.Text
  data                String?  @db.Text // JSONB with details
  
  isRead              Boolean  @default(false) @map("is_read")
  isResolved          Boolean  @default(false) @map("is_resolved")
  resolvedAction      String?  @db.Text @map("resolved_action")
  
  createdAt           DateTime @default(now()) @map("created_at")
  readAt              DateTime? @map("read_at")
  resolvedAt          DateTime? @map("resolved_at")
  
  @@map("alerts")
}

// ============================================
// 12. BUSINESS PROFILE
// ============================================
model BusinessProfile {
  id                  Int      @id @default(autoincrement())
  
  // Business Info
  businessName        String   @map("business_name")
  businessType        String   @map("business_type") // amazon_fba, multichannel
  productCategory     String?  @map("product_category") // jewelry
  
  // Amazon Info
  sellerId            String?  @map("seller_id")
  marketplace         String?  // US, CA, UK, etc.
  
  // Inventory Strategy
  targetFbaDays       Int      @default(45) @map("target_fba_days")
  targetTotalDays     Int      @default(180) @map("target_total_days")
  safetyStockDays      Int      @default(14) @map("safety_stock_days")
  
  // Seasonality
  peakMonths          String?  @db.Text @map("peak_months") // JSON array [11, 12]
  peakMultiplier      Decimal? @db.Decimal(5, 2) @default(2.0) @map("peak_multiplier")
  slowMonths          String?  @db.Text @map("slow_months") // JSON array [1, 2]
  slowMultiplier      Decimal? @db.Decimal(5, 2) @default(0.5) @map("slow_multiplier")
  
  // Thresholds
  minProfitMargin     Decimal? @db.Decimal(5, 2) @map("min_profit_margin")
  minRoi              Decimal? @db.Decimal(5, 2) @map("min_roi")
  maxDaysOfStock      Int?     @map("max_days_of_stock")
  
  // Communication
  alertStyle          String   @default("balanced") @map("alert_style") // gentle, balanced, direct
  
  // Timezone & Currency
  timezone            String   @default("America/New_York")
  currency            String   @default("USD")
  dateFormat          String   @default("MM/DD/YYYY") @map("date_format")
  numberFormat        String   @default("en-US") @map("number_format")
  
  // Setup
  interviewCompleted  Boolean  @default(false) @map("interview_completed")
  interviewCompletedAt DateTime? @map("interview_completed_at")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("business_profile")
}

// ============================================
// 13. API CONNECTIONS
// ============================================
model ApiConnection {
  id                  Int      @id @default(autoincrement())
  platform            String   // amazon, linnworks, shopify
  
  isConnected         Boolean  @default(false) @map("is_connected")
  isPrimary           Boolean  @default(false) @map("is_primary")
  
  // What it provides
  provides            String?  @db.Text // JSON array ['fba_inventory', 'orders', 'fees']
  
  // Credentials (encrypted!)
  credentials         String?  @db.Text // JSONB, encrypted
  
  // Sync
  syncEnabled         Boolean  @default(true) @map("sync_enabled")
  syncFrequencyMinutes Int     @default(60) @map("sync_frequency_minutes")
  lastSyncAt         DateTime? @map("last_sync_at")
  lastSyncStatus      String?  @map("last_sync_status")
  lastSyncError       String?  @db.Text @map("last_sync_error")
  
  // Health
  consecutiveFailures Int      @default(0) @map("consecutive_failures")
  lastSuccessfulSync  DateTime? @map("last_successful_sync")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@unique([platform])
  @@map("api_connections")
}

// ============================================
// 14. WORKFLOWS
// ============================================
model Workflow {
  id                  Int      @id @default(autoincrement())
  workflowId          String   @unique @map("workflow_id")
  name                String
  description         String?  @db.Text
  
  // Definition
  nodes               String?  @db.Text // JSONB array of steps
  connections         String?  @db.Text // How steps connect
  
  // Trigger
  triggerType         String   @map("trigger_type") // manual, scheduled, event
  triggerConfig       String?  @db.Text @map("trigger_config")
  
  // Status
  isActive            Boolean  @default(true) @map("is_active")
  isSystem            Boolean  @default(false) @map("is_system") // Built-in vs user-created
  
  // Relations
  runs                WorkflowRun[]
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("workflows")
}

model WorkflowRun {
  id                  Int      @id @default(autoincrement())
  workflowId          String   @map("workflow_id")
  workflow            Workflow @relation(fields: [workflowId], references: [workflowId], onDelete: Cascade)
  
  status              String   // running, paused, completed, failed
  currentNode         String?  @map("current_node")
  
  context             String?  @db.Text // Data being passed through
  
  startedAt           DateTime @default(now()) @map("started_at")
  pausedAt            DateTime? @map("paused_at")
  completedAt          DateTime? @map("completed_at")
  
  // If waiting
  waitingFor          String?  @map("waiting_for") // approval, user_input
  waitingData         String?  @db.Text @map("waiting_data")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("workflow_runs")
}

// ============================================
// 15. MODULES
// ============================================
model Module {
  id                  Int      @id @default(autoincrement())
  moduleId            String   @unique @map("module_id")
  name                String
  description         String?  @db.Text
  type                String   // widget, tool, automation, report
  
  // Definition
  config              String?  @db.Text // Module settings
  code                String?  @db.Text // Generated code
  
  // UI
  icon                String?
  dashboardPosition   String?  @db.Text @map("dashboard_position")
  menuPosition        String?  @map("menu_position")
  
  status              String   @default("active") // active, disabled
  createdBy           String   @default("user") @map("created_by") // advisor, user
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("modules")
}

// ============================================
// 16. USER & ROLES
// ============================================
model User {
  id                  Int      @id @default(autoincrement())
  email               String   @unique
  name                String
  role                String   // owner, manager, staff, va, accountant
  
  // Permissions
  permissions         String?  @db.Text // JSONB or link to role_permissions
  
  // Preferences
  timezone            String   @default("America/New_York")
  dateFormat          String   @default("MM/DD/YYYY") @map("date_format")
  notificationPreferences String? @db.Text @map("notification_preferences")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("users")
}

model AuditLog {
  id                  Int      @id @default(autoincrement())
  userId              Int?     @map("user_id")
  
  action              String   // created_po, edited_product, etc.
  entityType          String   @map("entity_type") // product, po, shipment
  entityId            String?  @map("entity_id")
  
  beforeData          String?  @db.Text @map("before_data")
  afterData           String?  @db.Text @map("after_data")
  
  createdAt           DateTime @default(now()) @map("created_at")
  ipAddress           String?  @map("ip_address")
  
  @@map("audit_log")
}

// ============================================
// 17. APPROVAL SYSTEM
// ============================================
model PendingAction {
  id                  Int      @id @default(autoincrement())
  
  // What action
  actionType          String   @map("action_type") // create_po, update_product, install_module
  actionData          String?  @db.Text @map("action_data") // JSONB with full details
  
  // Preview
  previewText         String   @db.Text @map("preview_text")
  previewData         String?  @db.Text @map("preview_data") // JSONB for UI
  
  // Impact analysis
  impactSummary       String?  @db.Text @map("impact_summary")
  affectedRecords     String?  @db.Text @map("affected_records")
  
  // Status
  status              String   @default("pending") // pending, approved, rejected, expired
  
  // Approval
  createdAt           DateTime @default(now()) @map("created_at")
  expiresAt           DateTime? @map("expires_at")
  approvedAt          DateTime? @map("approved_at")
  approvedBy          Int?     @map("approved_by")
  rejectionReason     String?  @db.Text @map("rejection_reason")
  
  // Execution
  executedAt          DateTime? @map("executed_at")
  executionResult     String?  @db.Text @map("execution_result")
  executionError      String?  @db.Text @map("execution_error")
  
  @@map("pending_actions")
}

model ActionHistory {
  id                  Int      @id @default(autoincrement())
  
  actionType          String   @map("action_type")
  actionData          String?  @db.Text @map("action_data")
  previewText         String   @db.Text @map("preview_text")
  
  approvedBy          Int?     @map("approved_by")
  approvedAt          DateTime @map("approved_at")
  
  result              String   // success, failed, partial
  resultData          String?  @db.Text @map("result_data")
  
  // For undo capability
  canUndo             Boolean  @default(false) @map("can_undo")
  undoData            String?  @db.Text @map("undo_data")
  undoneAt            DateTime? @map("undone_at")
  
  createdAt           DateTime @default(now()) @map("created_at")
  
  @@map("action_history")
}

// ============================================
// 18. ADDITIONAL SYSTEMS
// ============================================
model Marketplace {
  id                  Int      @id @default(autoincrement())
  marketplaceId       String   @unique @map("marketplace_id") // ATVPDKIKX0DER (US), etc.
  name                String   // "Amazon US", "Amazon CA"
  countryCode         String   @map("country_code") // US, CA, UK, DE
  
  currency            String   // USD, CAD, GBP, EUR
  timezone            String   // America/New_York, Europe/London
  
  // Amazon credentials for this marketplace
  isConnected         Boolean  @default(false) @map("is_connected")
  credentials         String?  @db.Text // Encrypted
  
  // Settings
  isActive            Boolean  @default(true) @map("is_active")
  primaryMarketplace  Boolean  @default(false) @map("primary_marketplace")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("marketplaces")
}

model CurrencyRate {
  id                  Int      @id @default(autoincrement())
  fromCurrency        String   @map("from_currency")
  toCurrency          String   @map("to_currency")
  rate                Decimal  @db.Decimal(10, 4)
  
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at")
  
  @@unique([fromCurrency, toCurrency])
  @@map("currency_rates")
}

model InventoryAdjustment {
  id                  Int      @id @default(autoincrement())
  masterSku           String   @map("master_sku")
  location            String   // 'warehouse', 'fba'
  
  // Adjustment
  adjustmentType      String   @map("adjustment_type") // damage, shrinkage, audit, correction, found, other
  quantityChange      Int      @map("quantity_change") // Can be negative or positive
  
  // Before/After
  quantityBefore      Int      @map("quantity_before")
  quantityAfter       Int      @map("quantity_after")
  
  // Details
  reason              String   @db.Text
  reference           String?  // PO number, audit ID, etc.
  
  // Tracking
  adjustedBy          Int?     @map("adjusted_by")
  adjustedAt          DateTime @default(now()) @map("adjusted_at")
  
  // Approval
  requiresApproval    Boolean  @default(false) @map("requires_approval")
  approvedBy          Int?     @map("approved_by")
  approvedAt          DateTime? @map("approved_at")
  
  @@map("inventory_adjustments")
}

model Bundle {
  id                  Int      @id @default(autoincrement())
  bundleProductId     String   @unique @map("bundle_product_id")
  bundleProduct       Product  @relation("BundleProduct", fields: [bundleProductId], references: [sku], onDelete: Cascade)
  
  isActive            Boolean  @default(true) @map("is_active")
  autoCalculateInventory Boolean @default(true) @map("auto_calculate_inventory")
  
  components          BundleComponent[]
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("bundles")
}

model BundleComponent {
  id                  Int      @id @default(autoincrement())
  bundleProductId     String   @map("bundle_product_id")
  bundle              Bundle   @relation(fields: [bundleProductId], references: [bundleProductId], onDelete: Cascade)
  
  componentProductId  String   @map("component_product_id")
  componentProduct    Product  @relation("ComponentProduct", fields: [componentProductId], references: [sku], onDelete: Cascade)
  
  quantity            Int      // How many of this component per bundle
  
  @@unique([bundleProductId, componentProductId])
  @@map("bundle_components")
}

